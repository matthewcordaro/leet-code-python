from bisect import bisect_right
from collections import defaultdict
import unittest


# O(n^2) speed, O(n)
# Fib like form is arr[i] + arr[j] = arr[k]
#
# Method:
# For each k, and each j preceding k where arr[j] > arr[k]/2, (strictly increasing!)
#   if an i exists such that: arr[i] + arr[j] = arr[k],
#     Set subsequence length (j, k) to subsequence length (i, j) plus 1 for k
#     Update the longest subsequence if necessary
#
# Note: Subsequence Length Dictionary (..., i, j, k), stored as `[j, k]: length`
#   with a default value of 2, so we can +1 when first found making it 3.
class Solution:
    # noinspection PyMethodMayBeStatic
    def lenLongestFibSubseq(self, arr: list[int]) -> int:
        longest_subsequence = 0
        index_from_value_table = {x: i for i, x in enumerate(arr)}
        subsequence_length_dict = defaultdict(lambda: 2)
        for k, k_val in enumerate(arr):
            jlo = bisect_right(arr, k_val // 2, hi=k)  # arr[j] > arr[k]/2
            for j_val in arr[jlo:k]:
                j = index_from_value_table[j_val]
                i = index_from_value_table.get(k_val - j_val, None)
                if i is None:
                    continue
                seq = subsequence_length_dict[i, j] + 1
                subsequence_length_dict[j, k] = seq
                longest_subsequence = max(longest_subsequence, seq)
        return longest_subsequence


class TestSolution(unittest.TestCase):
    def setUp(self):
        self.sol = Solution()

    def test_solution(self):
        self.assertEqual(0, self.sol.lenLongestFibSubseq([1, 3, 5]))
        self.assertEqual(3, self.sol.lenLongestFibSubseq([1, 2, 3, 4]))
        self.assertEqual(5, self.sol.lenLongestFibSubseq([1, 2, 3, 4, 5, 6, 7, 8]))
        self.assertEqual(5, self.sol.lenLongestFibSubseq([0, 1, 2, 3, 4, 5, 6, 7, 8]))
        self.assertEqual(3, self.sol.lenLongestFibSubseq([1, 3, 7, 11, 12, 14, 18]))
        self.assertEqual(5, self.sol.lenLongestFibSubseq(
            [2, 4, 7, 8, 9, 10, 14, 15, 18, 23, 32, 50]))
        self.assertEqual(5, self.sol.lenLongestFibSubseq(
            [1, 2, 3, 6, 7, 8, 9, 10, 12, 14, 21, 33]))
        a = [1166, 1536, 2942, 5199, 5864, 7208, 7307, 8737, 9561, 10609, 10784, 11086, 12106,
             13101, 14195, 15535, 15720,
             16138, 17375, 18376, 18982, 21910, 22823, 23283, 23428, 23566, 24409, 24769,
             25331, 26402, 27776, 28138, 29334,
             29658, 30400, 32925, 33474, 34786, 35437, 36301, 36443, 38066, 38616, 42860,
             45836, 46263, 46445, 46911, 51973,
             52070, 52561, 56340, 56414, 59579, 59980, 66218, 66373, 67234, 70393, 70487,
             74537, 76076, 77361, 78326, 78987,
             79622, 80462, 81390, 81454, 81809, 82477, 84608, 85496, 85958, 86671, 86780,
             87103, 88120, 91224, 91658, 91922,
             93742, 93903, 95413, 95839, 95970, 96106, 96740, 97838, 99468, 99494, 99541,
             100732, 100792, 102127, 102662,
             107240, 107782, 110844, 111127, 111356, 116266, 118719, 120776, 121491, 121998,
             124982, 127825, 129759, 130009,
             131155, 131596, 131744, 140056, 140929, 141999, 142917, 143830, 146287, 146766,
             148469, 149605, 150720, 153225,
             153495, 154589, 154716, 158971, 159559, 159736, 160735, 161087, 161100, 161427,
             163237, 164133, 165090, 165599,
             166740, 168267, 170609, 171566, 172920, 174730, 175517, 175905, 176369, 177169,
             179891, 180199, 180376, 181893,
             182281, 182447, 185002, 185903, 186191, 188031, 189799, 191479, 193544, 196054,
             198807, 200654, 200672, 201366,
             202234, 204343, 204544, 208264, 209586, 209716, 210345, 210602, 210732, 210761,
             210944, 211501, 211728, 211773,
             212257, 215365, 215433, 218398, 219043, 221696, 223302, 224263, 229591, 230319,
             231391, 231593, 232640, 232844,
             235784, 236501, 238399, 238415, 240606, 241686, 244006, 244291, 245798, 246932,
             247427, 248836, 249415, 252231,
             252434, 253494, 254059, 254420, 256009, 258151, 259773, 263367, 263941, 264500,
             266356, 267254, 268920, 269185,
             270050, 271576, 274290, 275154, 276165, 277162, 277918, 278109, 282545, 283213,
             283386, 283667, 286260, 288738,
             288942, 289017, 289679, 289785, 290882, 292435, 296563, 297485, 298810, 299750,
             299945, 300491, 301216, 301566,
             302929, 306145, 306279, 307010, 307587, 307712, 308845, 309578, 312094, 313527,
             313811, 314386, 314777, 315187,
             315464, 315653, 316793, 317008, 318441, 319613, 320608, 322244, 322761, 322905,
             324865, 326787, 328537, 329221,
             330426, 331637, 331735, 331953, 332551, 336924, 337308, 337839, 338169, 338466,
             339188, 339753, 342148, 342955,
             344443, 344844, 345530, 347058, 354601, 355302, 357345, 358038, 359982, 360725,
             361735, 362575, 362940, 363228,
             364240, 367446, 370061, 371064, 371230, 373126, 373130, 373197, 378875, 380809,
             381203, 381885, 382208, 382227,
             383241, 384708, 387115, 388229, 389815, 390993, 391202, 395961, 397892, 398081,
             398414, 398831, 403792, 404284,
             404757, 404899, 405425, 407357, 409927, 410294, 410876, 413506, 414135, 415533,
             415582, 416519, 416915, 418694,
             419362, 421144, 424288, 426416, 426455, 426478, 426989, 429142, 429197, 430622,
             432355, 432909, 433602, 434434,
             435156, 435829, 436720, 437546, 437943, 439071, 439270, 439398, 439457, 441648,
             446414, 447203, 450106, 451591,
             452372, 455114, 456890, 461226, 461293, 461978, 462344, 462604, 463316, 463359,
             463893, 464759, 464912, 466435,
             467228, 468386, 468868, 470219, 471005, 474162, 474990, 475008, 476391, 477214,
             477550, 479964, 481184, 482247,
             483467, 483806, 484568, 484777, 485191, 488111, 488679, 491163, 494205, 495585,
             497069, 497194, 499862, 500199,
             500943, 501388, 503114, 503379, 505925, 509985, 511023, 512540, 512704, 513858,
             514148, 516436, 516958, 518434,
             520871, 522880, 523912, 524190, 525867, 525951, 529583, 529817, 532139, 533012,
             533800, 535557, 536031, 536870,
             537480, 537740, 537780, 538043, 538661, 538729, 538841, 539168, 542100, 543029,
             543307, 543999, 547532, 548751,
             549955, 549978, 551361, 551657, 552113, 554539, 555768, 557893, 558768, 560373,
             560861, 560951, 561006, 562053,
             563782, 564028, 565648, 565768, 566115, 567591, 569409, 570139, 570325, 570403,
             572328, 572741, 573011, 575503,
             578011, 578096, 578301, 579200, 580029, 580825, 581033, 581216, 584252, 585787,
             586762, 588745, 591826, 592175,
             592679, 593593, 596218, 596458, 596621, 596905, 598658, 600839, 602840, 603249,
             603986, 607875, 610607, 610660,
             613758, 615284, 615816, 617532, 618268, 618956, 621186, 622432, 623695, 627376,
             630328, 632653, 633797, 635962,
             637192, 638379, 642680, 643530, 646561, 649199, 649312, 650729, 654090, 654118,
             655052, 655084, 658396, 660695,
             662550, 662634, 662657, 663171, 663483, 663613, 667077, 667496, 668685, 668948,
             671789, 675391, 675896, 676515,
             677402, 678461, 678926, 680138, 681141, 681763, 682031, 683155, 684449, 688391,
             690561, 693125, 696168, 697438,
             699620, 699778, 699803, 701275, 707680, 708104, 709087, 709757, 709861, 709967,
             711159, 712297, 717366, 718399,
             718944, 721171, 721429, 723542, 724252, 727142, 727762, 728988, 729869, 732010,
             735745, 735919, 737686, 739368,
             739490, 739583, 740981, 741055, 741400, 744284, 745818, 752653, 754291, 755200,
             758960, 763557, 764485, 764690,
             765151, 766740, 768063, 771482, 776789, 778701, 781391, 784196, 785411, 787413,
             787687, 787799, 788529, 789307,
             789364, 789959, 790240, 793059, 794829, 796054, 796077, 797532, 797829, 799354,
             806224, 807226, 808756, 813521,
             813684, 817291, 818729, 820943, 821167, 821212, 823974, 828252, 830326, 830393,
             831195, 832686, 833709, 834969,
             835076, 835454, 836509, 838200, 839512, 840017, 840127, 840185, 840301, 840444,
             841782, 842433, 843394, 843408,
             844142, 844253, 846399, 849809, 851679, 853104, 853745, 854142, 856997, 858126,
             863104, 863297, 863878, 863959,
             866723, 867117, 868200, 868849, 869275, 870280, 871263, 873945, 875533, 875945,
             876044, 876886, 878822, 882790,
             883102, 884668, 885842, 889841, 892740, 893031, 896816, 897445, 899318, 901155,
             901205, 903050, 903159, 904245,
             905017, 906452, 907483, 909986, 910903, 911319, 916598, 919279, 922157, 923829,
             925014, 925428, 925652, 925658,
             925853, 927036, 927134, 928150, 928355, 930529, 933017, 933081, 936171, 937437,
             938198, 938382, 939634, 940670,
             941852, 941883, 942673, 943480, 943652, 945345, 945765, 949954, 949968, 950805,
             952137, 952668, 953198, 954220,
             957717, 960343, 962263, 963663, 965778, 966814, 966971, 967213, 968408, 968920,
             968949, 973777, 973958, 976337,
             977340, 979156, 981691, 981769, 984564, 985032, 985383, 986212, 989377, 990110,
             990146, 991379, 991577, 992250,
             994018, 997423, 998516]
        self.assertEqual(3, self.sol.lenLongestFibSubseq(a))
        b = [3003, 3526, 5130, 9229, 10998, 12483, 13820, 15247, 16460, 17215, 18385, 18844,
             22096, 24315, 26015, 26984,
             27395, 27949, 30680, 30784, 30875, 33669, 36744, 36864, 37431, 38415, 38482,
             39476, 41889, 42001, 42360, 44040,
             47861, 49725, 52368, 53376, 54403, 54496, 56339, 57718, 58675, 58692, 62547,
             63005, 63317, 63349, 67435, 68030,
             68043, 69132, 71365, 71439, 72969, 75467, 80039, 84433, 85063, 85370, 86912,
             87908, 88952, 89498, 89924, 90433,
             92439, 93094, 93628, 93907, 95807, 97363, 99093, 100052, 100608, 101012, 101549,
             101606, 102867, 105011,
             106593, 107879, 107905, 110070, 110279, 110784, 110995, 116612, 117690, 117914,
             119158, 122329, 123641, 123688,
             126033, 129772, 131906, 133596, 133923, 135039, 135278, 136180, 137852, 138297,
             139991, 140225, 140568, 141319,
             142357, 143980, 147129, 147848, 148354, 148866, 149381, 149745, 150404, 150564,
             153374, 153427, 154853, 155996,
             156078, 156702, 157294, 157596, 158555, 158689, 163283, 163353, 163789, 167462,
             169031, 169580, 169861, 170109,
             172853, 173557, 175387, 175915, 176267, 176462, 177541, 178215, 178660, 178801,
             182996, 185563, 194065, 194669,
             196886, 198742, 199450, 200892, 202318, 202989, 204949, 208068, 208822, 213959,
             215406, 215681, 215873, 217410,
             219392, 219467, 220485, 223160, 223325, 223428, 224064, 224576, 225457, 226029,
             226784, 227847, 228228, 228528,
             228908, 228952, 229105, 232552, 234226, 234912, 235717, 238412, 238457, 243153,
             243461, 244010, 244229, 244230,
             245072, 245712, 249026, 249139, 250610, 251044, 253192, 253926, 255096, 255805,
             256095, 256255, 256955, 257314,
             259063, 259287, 262468, 263157, 264620, 266132, 267104, 269373, 270643, 270663,
             270720, 270839, 279241, 280253,
             280263, 282521, 282900, 282958, 285750, 286747, 288109, 288338, 290253, 290511,
             293987, 294533, 295832, 295904,
             297061, 297765, 298638, 302826, 304373, 304891, 304979, 306259, 307724, 311037,
             314766, 314982, 316755, 319463,
             320879, 322098, 324679, 324814, 326730, 327646, 327706, 328417, 328954, 329108,
             329655, 332539, 332757, 334416,
             334974, 335169, 335497, 336126, 338178, 341646, 342944, 343691, 344491, 345105,
             346602, 347542, 347869, 348714,
             351436, 351979, 352029, 352472, 354236, 355897, 356409, 360491, 362420, 370659,
             372206, 373164, 373552, 376406,
             377998, 380548, 384154, 384897, 385398, 386970, 390080, 392280, 394780, 396955,
             397754, 398004, 399043, 399839,
             401263, 401696, 404867, 406871, 407624, 408378, 409509, 409740, 410039, 415845,
             416084, 416142, 416749, 416779,
             417864, 418733, 419245, 419904, 421802, 421829, 424503, 424562, 424823, 425417,
             425944, 426393, 427174, 427962,
             429552, 430050, 430571, 431902, 432503, 433166, 434084, 437083, 438993, 439783,
             440439, 440470, 440876, 441114,
             441883, 443233, 443933, 445214, 445594, 445623, 446578, 449673, 449976, 450156,
             451026, 452267, 452693, 453848,
             454074, 455417, 455963, 456635, 458826, 464611, 465308, 466190, 468284, 474738,
             475005, 475345, 479394, 480099,
             481150, 482593, 482971, 486676, 487679, 489667, 490382, 494793, 495275, 497663,
             497986, 498094, 499375, 500768,
             500904, 504131, 505269, 509957, 510802, 514811, 517427, 518558, 520466, 524405,
             525307, 527582, 529299, 533896,
             534546, 534727, 536961, 540877, 543300, 543578, 543612, 543626, 543899, 546072,
             547044, 552342, 552423, 552894,
             552925, 553049, 553238, 553843, 554365, 557175, 557990, 560883, 562038, 562365,
             563581, 563724, 566443, 567359,
             569050, 569140, 573106, 575072, 575556, 577865, 578314, 579168, 580528, 581178,
             582280, 587752, 588089, 588714,
             589097, 589714, 590922, 591397, 591993, 593755, 595859, 596425, 597281, 599803,
             600441, 602718, 603624, 604793,
             607896, 609296, 611553, 612302, 613217, 613248, 613747, 617572, 622317, 623224,
             623296, 624249, 625202, 625430,
             626409, 627222, 627759, 627912, 629811, 630045, 631819, 633141, 633259, 635720,
             637038, 637115, 640953, 643081,
             644407, 645907, 646471, 646500, 647295, 648282, 650195, 650610, 650616, 654178,
             655001, 656588, 656927, 661061,
             661391, 662660, 663145, 666293, 669873, 670056, 671105, 671825, 672478, 672686,
             674166, 674571, 677506, 677672,
             679166, 680942, 682900, 685150, 685931, 686693, 689161, 690305, 690909, 690939,
             693108, 697674, 699421, 702130,
             702639, 703177, 706275, 707522, 707767, 707890, 710543, 711783, 711908, 712284,
             712374, 712695, 713462, 714955,
             716035, 719083, 722925, 723950, 723983, 725591, 726742, 728071, 728547, 729402,
             730591, 730943, 731928, 733194,
             734372, 734682, 735328, 735878, 737238, 737440, 737942, 739819, 741122, 742018,
             743892, 744427, 745568, 746882,
             748053, 749250, 749411, 749497, 749881, 752336, 754698, 755434, 758402, 761076,
             765364, 765446, 766521, 767667,
             768273, 772185, 772705, 773378, 774806, 777200, 777709, 780334, 792191, 792486,
             793294, 797137, 802038, 802145,
             803537, 803694, 804719, 808152, 808886, 810063, 810243, 812650, 813728, 815647,
             819008, 819361, 819592, 819752,
             821536, 825558, 825896, 826085, 826495, 828481, 829490, 829530, 829536, 830891,
             831442, 832520, 836237, 840422,
             841682, 842080, 843420, 845745, 847418, 848814, 849820, 849824, 850982, 851454,
             852532, 853165, 854837, 855315,
             856171, 858009, 858628, 859451, 859838, 859920, 861874, 862432, 863373, 864409,
             867716, 868427, 870133, 870471,
             871248, 873674, 875338, 875885, 879333, 879337, 882361, 883489, 883534, 884264,
             884334, 885568, 888046, 888712,
             890791, 891555, 891803, 893810, 895495, 895509, 895529, 897765, 899290, 900266,
             900431, 900537, 904110, 906632,
             907142, 908828, 909285, 909464, 910445, 910795, 911664, 913041, 916820, 918835,
             919599, 920252, 921232, 921246,
             921549, 922201, 922924, 922966, 924244, 924611, 925657, 926437, 927031, 928811,
             930320, 930994, 931285, 931412,
             932255, 932559, 933676, 934650, 934890, 937547, 938082, 939299, 939330, 939828,
             939942, 940857, 944797, 945383,
             946549, 946844, 952050, 953011, 954328, 956188, 956786, 957019, 959475, 961254,
             961382, 962128, 962807, 963909,
             964971, 966469, 967011, 969003, 970598, 971152, 971306, 972702, 972916, 975645,
             975753, 977109, 977889, 977985,
             978770, 979890, 980495, 980803, 980949, 980950, 982001, 983888, 985367, 987033,
             988531, 989338, 989783, 991948,
             997114, 997980, 999005]
        self.assertEqual(3, self.sol.lenLongestFibSubseq(b))


def main():
    unittest.main()


if __name__ == '__main__':
    main()
